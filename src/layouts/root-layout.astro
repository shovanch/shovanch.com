---
import { ClientRouter } from 'astro:transitions';
import Footer from '~/components/footer.astro';
---

<script is:inline>
  // eslint-disable-next-line ts/explicit-function-return-type
  function setThemeMode(document) {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia('(prefers-color-scheme: dark)').matches;
    const storedTheme = localStorage.getItem('theme');

    // Determine theme: stored preference -> system preference -> dark as fallback
    let theme;
    if (storedTheme) {
      theme = storedTheme;
    } else if (prefersDark) {
      theme = 'dark';
    } else {
      theme = 'light'; // Respect light system preference
    }

    // Remove all theme classes
    document.documentElement.classList.remove('dark', 'blue');

    // Apply the appropriate theme
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else if (theme === 'blue') {
      document.documentElement.classList.add('blue');
    }
    // Light theme is default (no class needed)
  }

  setThemeMode(document);

  document.addEventListener('astro:before-swap', (ev) => {
    setThemeMode(ev.newDocument);
  });
</script>

<!-- Remove font preload when swapping pages: REF: https://github.com/withastro/astro/issues/10425 -->
<script>
  import type { TransitionBeforeSwapEvent } from 'astro:transitions/client';
  document.addEventListener('astro:before-swap', (e) =>
    [
      ...(e as TransitionBeforeSwapEvent).newDocument.head.querySelectorAll(
        'link[as="font"]',
      ),
    ].forEach((link) => link.remove()),
  );
</script>

<ClientRouter />
<div
  id="root-container"
  class="relative flex min-h-screen flex-col overflow-x-hidden antialiased"
>
  <div
    class="relative mx-auto mt-2 mb-auto flex w-full max-w-3xl flex-col items-center justify-start p-4 md:mt-6"
  >
    <main class="flex w-full flex-col gap-10 md:gap-12">
      <slot />
    </main>
  </div>
  <Footer />
</div>

<head>
  <script>
    // @ts-ignore
    import nprogress from 'nprogress';

    document.addEventListener('astro:before-preparation', () => {
      nprogress.start();
    });

    document.addEventListener('astro:page-load', () => {
      nprogress.done();
    });
  </script>

  <link
    rel="alternate"
    type="application/rss+xml"
    title="RSS Feed for shovanch.com"
    href="/rss.xml"
  />
</head>
